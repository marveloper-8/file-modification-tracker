# File Modification Tracker

The **File Modification Tracker** is a system service designed to track file modifications on a Windows system using **osquery**, log the results, and provide interfaces to interact with the service via an HTTP API and a Windows UI. This project is structured using **Hexagonal Architecture** (Ports and Adapters), making it flexible, maintainable, and scalable.

## Table of Contents

1. [Features](#features)
2. [Architecture](#architecture)
3. [Installation](#installation)
4. [Running the Application](#running-the-application)
5. [HTTP API](#http-api)
6. [UI Interface](#ui-interface)
7. [Configuration](#configuration)
8. [Testing](#testing)
9. [Logging](#logging)

## Features

- Tracks file modifications in a specified directory using **osquery**.
- Exposes an HTTP API for system health, command management, and logs.
- Provides a Windows UI using the **Fyne** framework.
- Log errors and file stats using **Logrus**.
- Easily configurable via a YAML file.
- Structured using Hexagonal Architecture.

## Architecture

This project is built using **Hexagonal Architecture**, also known as **Ports and Adapters**. The architecture is divided into the following layers:

- **Core**: Contains the business logic of the application. Interfaces (Ports) are defined here.
- **Adapters**: Implements the interfaces from the core and interacts with external systems such as logging, osquery, HTTP server, and UI.
- **Infrastructure**: Contains configuration and setup code.
  
```
file-modification-tracker/
├── cmd/                                # Entrypoint
│   └── service/
│       └── main.go                     # Main service code
├── internal/
│   ├── adapters/
│   │   ├── config/                     # Configuration handling
│   │   ├── daemon/                     # Daemon management
│   │   ├── http/                       # HTTP server
│   │   ├── logs/                       # Logging functionality
│   │   ├── osquery/                    # Osquery integration
│   │   └── ui/                         # Windows UI
│   └── core/                           # Business logic and interfaces
├── tests/                              # Unit tests
├── config.yaml                         # Configuration file (YAML)
├── service.wxs                         # WiX configuration for MSI packaging
├── go.mod                              # Go module file
├── go.sum                              # Go dependencies
└── README.md                           # Project documentation
```

## Installation

### Prerequisites

- **Go** (1.18+)
- **osquery** (installed and available in your system path)
- **WiX Toolset** (for MSI packaging on Windows)

### Steps

1. Clone the repository:

    ```bash
    git clone https://github.com/your-repo/file-modification-tracker.git
    cd file-modification-tracker
    ```

2. Install Go dependencies:

    ```bash
    go mod tidy
    ```

3. Install `osquery` on your system, if not already installed. You can find installation instructions on the official [osquery website](https://osquery.io/).

4. Build the project:

    ```bash
    go build -o bin/file-modification-tracker cmd/service/main.go
    ```

5. (Optional) Package the application as an MSI installer using WiX:

    ```bash
    candle service.wxs
    light service.wixobj -o FileModificationTracker.msi
    ```

## Running the Application

To run the application:

```bash
./bin/file-modification-tracker
```

The application will start:
- The service will begin tracking file modifications in the configured directory.
- An HTTP server will be available on port 8080.
- A UI window will open for interacting with the service on Windows.

## HTTP API

The application provides a simple HTTP API for health checks, command management, and retrieving logs.

### Endpoints

- **GET /health**: Returns the health status of the service.
- **POST /commands**: Accepts a list of commands to execute.
- **GET /logs**: Retrieves logs generated by the system.

Example usage:

```bash
curl http://localhost:8080/health
```

```json
{
  "status": "healthy"
}
```

## UI Interface

The application uses the **Fyne** framework to provide a basic Windows UI for interacting with the service.

- **Start Service**: Starts tracking file modifications.
- **Stop Service**: Stops the tracking service.
- **Logs Display**: Displays the logs generated by the service.

## Configuration

Configuration is done via the `config.yaml` file. Here’s an example of what the configuration looks like:

```yaml
directory: ./tracked_directory   # Directory to monitor
check_freq: 60                   # Frequency of checks (in seconds)
remote_api: http://localhost:8080 # API URL (if using remote interaction)
```

Ensure you set the correct values for your environment.

## Testing

Unit tests are available under the `tests/` directory. You can run the tests using the following command:

```bash
go test ./tests/...
```

### Sample Tests

- **Configuration Tests**: Ensures the configuration is loaded and validated correctly.
- **HTTP API Tests**: Tests the health and logs HTTP endpoints.
- **Worker and Daemon Tests**: Validates the worker threads and file modification tracking.

## Logging

Logging is handled using **Logrus**. Logs are output to both the console and retained internally for retrieval via the HTTP API or UI. Errors and file stats are logged with specific logging levels.